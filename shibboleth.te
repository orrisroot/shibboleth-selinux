# The policy_module macro declares the name of the module and its version.
# This is a key part of the modern SELinux policy language.
policy_module(shibboleth, 1.0.1)

# gen_require ensures that the necessary types from other modules are
# available for our policy. This is equivalent to require statements.
gen_require(`
    type kernel_t;
    type httpd_t;
')

########################################
#
# Declarations
#
# This section declares the custom types used in the policy.
# These types are used to label processes, files, and directories.
#

# Domain and executable file for the shibboleth daemon
type shibboleth_t;
type shibboleth_exec_t;
init_daemon_domain(shibboleth_t, shibboleth_exec_t)

# Unit file type for systemd service
type shibboleth_unit_file_t;
systemd_unit_file(shibboleth_unit_file_t)

# Configuration file type
type shibboleth_config_t;
files_config_file(shibboleth_config_t)

# PID file type
type shibboleth_run_t;
files_pid_file(shibboleth_run_t)

# Cache directory and file type
type shibboleth_cache_t;
files_type(shibboleth_cache_t)

# Log directory and file type
type shibboleth_log_t;
logging_log_file(shibboleth_log_t)

########################################
#
# Shibboleth Local Policy
#
# This section defines the actual access permission rules between the
# shibboleth domain and other domains.
#

# Permissions for the daemon itself
allow shibboleth_t self:capability { setgid setuid };
allow shibboleth_t self:process { fork signal_perms };
allow shibboleth_t self:fifo_file rw_fifo_file_perms;
allow shibboleth_t self:unix_dgram_socket create_socket_perms;
allow shibboleth_t self:unix_stream_socket { create_stream_socket_perms listen };
allow shibboleth_t kernel_t:unix_dgram_socket sendto;
domain_use_interactive_fds(shibboleth_t)

# Other common rules
files_read_etc_files(shibboleth_t)
auth_use_nsswitch(shibboleth_t)
miscfiles_read_localization(shibboleth_t)
corenet_tcp_connect_http_port(shibboleth_t)
corenet_tcp_sendrecv_http_port(shibboleth_t)

# Permissions for shibboleth to access its own files
allow shibboleth_t shibboleth_config_t:dir list_dir_perms;
allow shibboleth_t shibboleth_config_t:file read_file_perms;
allow shibboleth_t shibboleth_config_t:lnk_file read_lnk_file_perms;

# Permissions for shibboleth to manage its runtime files (e.g., PID files)
manage_dirs_pattern(shibboleth_t, shibboleth_run_t, shibboleth_run_t)
manage_files_pattern(shibboleth_t, shibboleth_run_t, shibboleth_run_t)
manage_sock_files_pattern(shibboleth_t, shibboleth_run_t, shibboleth_run_t)
files_pid_filetrans(shibboleth_t, shibboleth_run_t, { dir file sock_file })

# Permissions for shibboleth to manage its cache
manage_dirs_pattern(shibboleth_t, shibboleth_cache_t, shibboleth_cache_t)
manage_files_pattern(shibboleth_t, shibboleth_cache_t, shibboleth_cache_t)
files_var_filetrans(shibboleth_t, shibboleth_cache_t, { file dir })

# Permissions for shibboleth to manage its log files
manage_dirs_pattern(shibboleth_t, shibboleth_log_t, shibboleth_log_t)
manage_files_pattern(shibboleth_t, shibboleth_log_t, shibboleth_log_t)
manage_lnk_files_pattern(shibboleth_t, shibboleth_log_t, shibboleth_log_t)
logging_log_filetrans(shibboleth_t, shibboleth_log_t, { file dir })

# Permissions for httpd to access shibboleth files
allow httpd_t shibboleth_config_t:file read_file_perms;
allow httpd_t shibboleth_config_t:lnk_file read_lnk_file_perms;
allow httpd_t shibboleth_cache_t:file read_file_perms;
allow httpd_t shibboleth_t:unix_stream_socket connectto;
allow httpd_t shibboleth_run_t:sock_file write;
